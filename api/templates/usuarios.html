<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Usuarios Registrados</title>
    <style>
        body { background: #f6f8fc; }
        .container { margin: 40px auto; width: 90%; }
        h1 { text-align: center; }
        table { border-collapse: collapse; width: 100%; background: #fff; box-shadow: 0 0 12px #ccc; }
        th, td { border: 1px solid #ccc; padding: 8px 16px; text-align: center; }
        th { background: #2962ff; color: #fff; }
        .btn-edit { color: #2962ff; cursor: pointer; text-decoration: underline; }
        .modal-bg {
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.3); align-items: center; justify-content: center; z-index: 10;
        }
        .modal {
            background: #fff; padding: 32px 24px; border-radius: 16px; min-width: 350px; text-align: center;
        }
        .modal input { padding: 8px; width: 90%; margin-top: 10px; }
        .modal button { margin-top: 12px; padding: 8px 18px; background: #2962ff; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
        .alert { background: #ffe082; padding: 10px; margin: 10px 0; border-radius: 8px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>
<div class="container">
    <h1>Usuarios Registrados</h1>
    <div id="alerta-pendiente"></div>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Huella</th>
                <th>Fecha Registro</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody id="usuarios-tbody"></tbody>
    </table>
</div>

<!-- Modal para actualizar nombre -->
<div class="modal-bg" id="modal-bg">
    <div class="modal">
        <h3>Asignar nombre a la huella</h3>
        <input type="text" id="nuevo-nombre" placeholder="Nombre del usuario">
        <input type="hidden" id="usuario-id">
        <div>
            <button onclick="guardarNombre()">Guardar</button>
            <button onclick="cerrarModal()">Cancelar</button>
        </div>
    </div>
</div>

<script>
let usuariosData = [];

function fetchUsuarios() {
    fetch('/api/usuarios')
    .then(res => res.json())
    .then(usuarios => {
        usuariosData = usuarios;
        renderUsuarios(usuarios);
        buscarPendiente(usuarios);
    });
}

function renderUsuarios(usuarios) {
    let tbody = document.getElementById('usuarios-tbody');
    tbody.innerHTML = '';
    usuarios.forEach(u => {
        tbody.innerHTML += `
        <tr>
            <td>${u.id}</td>
            <td>${u.nombre}</td>
            <td>${u.huella}</td>
            <td>${u.fecha_registro}</td>
            <td>${u.nombre === "Pendiente" ? `<span class="btn-edit" onclick="abrirModal(${u.id})">Asignar nombre</span>` : ''}</td>
        </tr>`;
    });
}

// Busca si hay pendientes y lanza alerta/modal
function buscarPendiente(usuarios) {
    let pendientes = usuarios.filter(u => u.nombre === "Pendiente");
    let alerta = document.getElementById('alerta-pendiente');
    if (pendientes.length > 0) {
        alerta.innerHTML = `⚠️ Hay ${pendientes.length} huella(s) sin nombre. <span class="btn-edit" onclick="abrirModal(${pendientes[0].id})">Asignar ahora</span>`;
        // Si quieres abrir automáticamente el modal cuando aparece uno nuevo:
        // abrirModal(pendientes[0].id);
    } else {
        alerta.innerHTML = '';
        cerrarModal();
    }
}

function abrirModal(id) {
    document.getElementById('modal-bg').style.display = 'flex';
    document.getElementById('usuario-id').value = id;
    document.getElementById('nuevo-nombre').value = '';
}

function cerrarModal() {
    document.getElementById('modal-bg').style.display = 'none';
}

function guardarNombre() {
    let id = document.getElementById('usuario-id').value;
    let nombre = document.getElementById('nuevo-nombre').value.trim();
    if (!nombre) {
        alert("Introduce un nombre válido");
        return;
    }
    fetch('/api/usuario/actualizar_nombre', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({id: id, nombre: nombre})
    }).then(() => {
        cerrarModal();
        fetchUsuarios();
    });
}

setInterval(fetchUsuarios, 4000); // Refresca usuarios cada 4 segundos
window.onload = fetchUsuarios;
</script>
</body>
</html>
