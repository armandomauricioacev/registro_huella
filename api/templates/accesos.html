<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registros de Acceso</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f6fa; }
        h1 { text-align: center; color: #232a34; margin-top: 30px; }
        .filtros { text-align: center; margin: 24px 0; }
        .filtros select, .filtros button {
            font-size: 15px;
            padding: 5px 8px;
            margin-right: 6px;
        }
        table { border-collapse: collapse; width: 90%; margin: 30px auto; background: #fff; box-shadow: 0 0 10px #aaa; }
        th, td { border: 1px solid #ccc; padding: 10px 16px; text-align: center; }
        th { background: #3d5afe; color: #fff; }
        tr:nth-child(even) { background: #f1f3f4; }
        .btn-back {
            display: block;
            margin: 25px auto 10px auto;
            padding: 10px 30px;
            background: #3d5afe;
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-back:hover { background: #1a237e; }
        #mensaje-acceso {
            text-align: center;
            font-size: 26px;
            margin-top: 14px;
            color: #2e7d32;
            min-height: 28px;
        }
    </style>
</head>
<body>
    <h1>Registros de Acceso</h1>
    <div class="filtros">
        <select id="usuarioSelect"></select>
        <button onclick="verTodos()">Ver Todos</button>
    </div>
    <div id="mensaje-acceso"></div>
    <table id="tabla-accesos">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Tipo</th>
                <th>Fecha de Acceso</th>
            </tr>
        </thead>
        <tbody>
            <!-- Relleno dinámico -->
        </tbody>
    </table>
    <button class="btn-back" onclick="window.location.href='/admin/menu'">Volver al menú</button>
    <script>
        let usuario_id = null;
        let ultimoId = null;

        // Cargar usuarios para el filtro
        function cargarUsuarios() {
            fetch('/api/usuarios').then(r=>r.json()).then(usuarios=>{
                const select = document.getElementById('usuarioSelect');
                select.innerHTML = `<option value="">-- Todos los usuarios --</option>`;
                usuarios.forEach(u=>{
                    select.innerHTML += `<option value="${u.id}">${u.nombre} (ID ${u.id})</option>`;
                });
            });
        }

        function verTodos() {
            usuario_id = null;
            document.getElementById('usuarioSelect').value = '';
            fetchAccesos();
        }

        document.getElementById('usuarioSelect').addEventListener('change', function() {
            usuario_id = this.value ? parseInt(this.value) : null;
            fetchAccesos();
        });

        // Refrescar la tabla cada 4s
        function fetchAccesos() {
            let url = usuario_id ? `/api/accesos/${usuario_id}` : "/api/accesos";
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    let tbody = document.querySelector("#tabla-accesos tbody");
                    tbody.innerHTML = "";
                    if (!data || data.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="4"><em>No hay registros</em></td></tr>`;
                    } else {
                        data.forEach(row => {
                            let fila = document.createElement("tr");
                            fila.innerHTML = `
                                <td>${row.id}</td>
                                <td>${row.nombre}</td>
                                <td>${row.tipo}</td>
                                <td>${new Date(row.fecha_acceso).toLocaleString()}</td>
                            `;
                            tbody.appendChild(fila);
                        });
                        // Mensaje en tiempo real (solo si es el más reciente)
                        if (data[0] && data[0].id !== ultimoId && usuario_id === null) {
                            mostrarMensaje(data[0].tipo, data[0].nombre);
                            ultimoId = data[0].id;
                        }
                    }
                });
        }

        function mostrarMensaje(tipo, nombre) {
            let mensaje = "";
            if (tipo === "entrada") mensaje = `¡Bienvenido, ${nombre}!`;
            else if (tipo === "salida") mensaje = `Hasta pronto, ${nombre}!`;
            document.getElementById('mensaje-acceso').textContent = mensaje;
        }

        cargarUsuarios();
        fetchAccesos();
        setInterval(fetchAccesos, 4000);
    </script>
</body>
</html>
